<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Spending Tracker</title>
  <link rel="stylesheet" type="text/css" href="main.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <label for="category">Category:</label>
    <input placeholder="Entertainment, Utilities, Bills, etc" type="text" id="category" name="category">
    <label for="price">Price:</label>
    <input placeholder="In US Dollars $" type="number" step="0.01" id="price" name="price">
    <button onclick="addExpense()">Add Expense</button>

    <p><span style="font-weight: bold; font-size: larger; color: red" id="errors"></span></p>

    <h1>Purchases</h1>
    <table id="expensesTable">
        <tr>
            <th>Day</th>
            <th>Category</th>
            <th>Price</th>
            <th></th>
        </tr>
    </table>

    <h2>Generate an expense report for the following weeks:</h2>
    <label for="from">From:</label>
    <input id="from" name="from" type="date">
    <label for="to">To:</label>
    <input id="to" name="to" type="date"><br>

    <button style="margin-top: 25px; margin-bottom: 25px;" onclick="generateExpenseReport()">Generate Expense Report</button>

    <h1>Total Expense Report</h1>
    <p><span style="font-weight: bold" id="totalSpent"></span></p>
    <table id="weeklyReportTable">
        <tr>
            <th>Category</th>
            <th>Total</th>
            <th>Percentage</th>
        </tr>
    </table>

    <div id="piechart" style="width: 900px; height: 500px;"></div>

  <script>
      // Instantiate Pie Chart
      google.charts.load('current', {'packages':['corechart']});
      google.setOnLoadCallback(drawPieChart);
      // Init expense and report variables
      var expenses = [];
      // Fetch expenses
      var getExpenses = function() {
          fetch('/expenses/getExpenses')
            .then(res => res.json())
            .then((expenseData) => { 
                // Clear any existing expenses on the front-end
                clearTable("expensesTable");
                expenses = [];
                // Display expenses on the front-end
                for (exp of expenseData) {
                    // Convert to human readable date
                    var dateRef = new Date(exp.day);
                    var dayNum = convertFromDate(dateRef);
                    // Create a display friendly expense object
                    expObj = {
                        day: dayNum,
                        category: exp.category,
                        price: "$" + exp.price,
                        _id: exp._id
                    }
                    // Push to local expenses array
                    expenses.push(expObj);
                    // Insert expense into expenses table
                    insertObjectIntoTable("expensesTable", expObj, true, deleteExpense);
                }
             })
            .catch(err => document.getElementById("errors").innerHTML = "ERROR: Couldn't find any expenses. Did you add any?");
      }

      // Get initial expenses
      getExpenses();

      // Delete expense
      var deleteExpense = function() {
          // Confirm deletion
          if (confirm("Are you sure you want to delete this expense?")) {
                fetch(`expenses/deleteExpense/${this.id}`, {
                method: 'DELETE'
            })
            .then(() => getExpenses())
            .catch(err => document.getElementById("errors").innerHTML = "There was a problem deleting that expense. Check your internet connection");
          } else {
              return;
          }
      }

      var addExpense = function() {
          // Get user input
          var category = document.getElementById("category").value;
          var price = parseFloat(document.getElementById("price").value);
          // Input validation
          if (!category || !price) {
              document.getElementById("errors").innerHTML = "ERROR: Please enter a valid category and price.";
              return;
          }
          // Post expenditure to the database
          fetch('/expenses/createExpense', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  category: category,
                  price: price
              })
          })
          .then(() => getExpenses())  
          .catch(err => document.getElementById("errors").innerHTML = "There was a problem adding that expense. Check your internet connection.");
      }

      // Insert object at the top of a table
      var insertObjectIntoTable = function(tableId, obj, delBtn, delHandle) {
          // Insert with delete button
          if (delBtn) {
            var tableRef = document.getElementById(tableId);
            var row = tableRef.insertRow(1);
            var deleteBtn = document.createElement("input");
            deleteBtn.type = "button";
            deleteBtn.value = "X";
            deleteBtn.id = obj._id;
            deleteBtn.classList.add("deleteButton");
            deleteBtn.onclick = delHandle;
            delete obj._id
            Object.values(obj).forEach(val => {
                var dataColumn = document.createElement("td");
                dataColumn.innerHTML = val;
                row.appendChild(dataColumn);
            });
            row.appendChild(deleteBtn);
          } 
          // Insert without delete button
          else {
            var tableRef = document.getElementById(tableId);
            var row = tableRef.insertRow(1);
            Object.values(obj).forEach(val => {
                var dataColumn = document.createElement("td");
                dataColumn.innerHTML = val;
                row.appendChild(dataColumn);
            });
          }
      }

      // Clear the values of a HTML table
      var clearTable = function(tableId) {
          var tableToClear = document.getElementById(tableId);
          while (tableToClear.rows.length > 1) {
              tableToClear.deleteRow(1);
          }
      }

      // Convert date object to human readable date
      var convertFromDate = function(dateToConvert) {
        return dateToConvert.getMonth() + 1 + "/" + dateToConvert.getDate() + "/" + dateToConvert.getFullYear();
      }

      // Convert date input values to dates
      var convertToDate = function(convertedDate) {
          convertedDate = convertedDate.split("-");
          return convertedDate = new Date(convertedDate[0], convertedDate[1] - 1, convertedDate[2]);
      }

      var buildWeeklyReportTable = function(weeklyReport, grandTotal) {
          // Generate weeklyReport table
          for (report in weeklyReport) {
            weeklyReportTable = document.getElementById("weeklyReportTable");
            var row = weeklyReportTable.insertRow(1);
            var categoryRow = row.insertCell(0);
            var totalRow = row.insertCell(1);
            var percentageRow = row.insertCell(2);
            categoryRow.innerHTML = report;
            totalRow.innerHTML = "$" + weeklyReport[report];
            percentageRow.innerHTML = Math.floor(((weeklyReport[report] / grandTotal) * 100)) + "%";
          }
      }

      // Generate a weekly expense report based off date ranges and values in the expenses array
      var generateExpenseReport = function() {
          // Clear the existing spending report if there is one
          clearTable("weeklyReportTable");
          // Init report values
          var grandTotal = 0;
          var weeklyReport = {};
          // Check if there are any expenses to report on
          if (expenses === undefined || expenses.length == 0) {
              document.getElementById("totalSpent").innerHTML = "ERROR: Found no purchases. Please log at least one purchase.";
              return;
          }
          // Get the to and from date values if there are any
          var from = convertToDate(document.getElementById("from").value);
          var to = convertToDate(document.getElementById("to").value);
          // Calculate expense report without date inputs
          if (!document.getElementById("from").value || !document.getElementById("to").value) {
                for (expense of expenses) {
                    let dateRef = new Date(expense.day);
                    grandTotal += parseFloat(expense.price.substr(1));
                    if (weeklyReport[expense.category] === undefined) {
                        weeklyReport[expense.category] = parseFloat(expense.price.substr(1));
                    } else {
                        weeklyReport[expense.category] += parseFloat(expense.price.substr(1));
                    }
                }
          } else {
              // Calculate expense report with date inputs
                for (expense of expenses) {
                    let dateRef = new Date(expense.day);
                    if (dateRef.getTime() >= from.getTime() && dateRef.getTime() <= to.getTime()) {
                        grandTotal += parseFloat(expense.price.substr(1));
                        if (weeklyReport[expense.category] === undefined) {
                            weeklyReport[expense.category] = parseFloat(expense.price.substr(1));
                        } else {
                            weeklyReport[expense.category] += parseFloat(expense.price.substr(1));
                        }
                    }
                }
          }
          // Display the results
          buildWeeklyReportTable(weeklyReport, grandTotal);
          var toDate = document.getElementById("to").value;
          var fromDate = document.getElementById("from").value;
          document.getElementById("totalSpent").innerHTML = "You've spent $" + grandTotal + " from " + fromDate + " to " + toDate + ".";
          drawPieChart(weeklyReport);
          window.scrollTo(0, document.body.scrollHeight);
      }

      // Draw a pie chart based off of the spending data
      var drawPieChart = function(weeklyReport) {
            // Generate pie chart
            weeklySpendingReport = Object.entries(weeklyReport);
            weeklySpendingReport.unshift(['Category', 'Money Spent'])
            var data = google.visualization.arrayToDataTable(weeklySpendingReport);
            var options = {
                title: 'Your Spending Report'
            };
            var chart = new google.visualization.PieChart(document.getElementById('piechart'));
            chart.draw(data, options);
      }
  </script>
</body>
</html>